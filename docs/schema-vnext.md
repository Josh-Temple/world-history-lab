# Schema vNext (Canonical + Derived)

## Philosophy: canonical vs derived

- **Canonical (`/data`)** is human-authored, format-agnostic, and expressive. It can carry EDTF-like intervals, uncertainty, and interpretive relation claims.
- **Derived (`/derived`)** is build-time output optimized for runtime use: numeric sort keys, timeline ordering, and per-unit eligibility indexes.
- Runtime clients can continue using MVP fields (`time.year_start`, `unit.event_ids`) while progressively adopting derived artifacts.

## Backward-compatible canonical additions

No existing fields are removed. New fields are optional.

### Event.time additions

Existing MVP field remains:

- `event.time.year_start: number` (still supported)

Optional additions:

- `event.time.start: string` (EDTF-ish)
- `event.time.end: string` (EDTF-ish)
- `event.time.precision: "year" | "month" | "day" | "range"`
- `event.time.certainty: "exact" | "approx" | "uncertain"`
- `event.time.calendar: "gregorian"` (default)

Rules:

- If `start`/`end` exist, event time is treated as interval `[start, end]`.
- Point events use equal start/end values.
- If `start`/`end` are absent, derivation falls back to `year_start` as `YYYY..YYYY`.

### Supported EDTF subset in v1 derivation

Supported now:

- `YYYY`
- `YYYY-MM`
- `YYYY-MM-DD`
- `YYYY/YYYY` (year range)
- `YYYY~` (approximate year)
- `YYYY?` (uncertain year)

Not supported yet (v1):

- Other EDTF forms are currently unsupported. Derivation warns and falls back to `year_start` when available.

### Event.relations additions (claims, not facts)

Optional field:

- `event.relations: RelationClaim[]`

Where each claim has:

- `type: "causes" | "contributes_to" | "triggers" | "enables" | "influenced" | "reaction_to"`
- `target_id: string`
- `confidence: "low" | "medium" | "high"`
- `evidence_source_ids: string[]`
- `note: string`

Relations are editorial claims with confidence and evidence links, not ground-truth facts.

### Unit editorial layer additions (optional)

Units remain non-exclusive editorial scopes. Existing `event_ids` behavior is unchanged.

Optional additions:

- `preferred_time_precision: "year" | "month" | "day"`
- `default_time_window_policy: { era_windows: [...] }`
- `parallel_tracks: { places?: string[]; polities?: string[] }`

## Derived artifacts (`/derived`)

Generated by `node scripts/derive.mjs`.

- `derived/events.normalized.json`
- `derived/index.events_by_year.json`
- `derived/index.events_sorted.json`
- `derived/index.units.json`
- `derived/index.unit_event_pool.json`

### Sort key derivation rules

- `YYYY` → `sort_start=YYYY0101`, `sort_end=YYYY1231`, precision=`year`
- `YYYY-MM` → `sort_start=YYYYMM01`, `sort_end=YYYYMM(lastDay)`, precision=`month`
- `YYYY-MM-DD` → `sort_start=YYYYMMDD`, `sort_end=YYYYMMDD`, precision=`day`
- `YYYY/YYYY` → `sort_start=startYear0101`, `sort_end=endYear1231`, precision=`range`
- `YYYY~` → year bounds, certainty=`approx`
- `YYYY?` → year bounds, certainty=`uncertain`

When parsing fails:

- Warn with event id.
- Fall back to `time.year_start` when available.
- Exclude event from derived outputs when no fallback exists.

## Validation behavior in derive script

Fail-fast checks:

- `data/events.json` must be an array.
- `data/people.json` must be an array.
- Every event must include `id`, `label`, and `time.year_start` or `time.start`.

Current warning-only behavior:

- Unit `event_ids` referencing unknown events log warnings.

## Examples

### Example 1: Event with EDTF interval + relations claim

```json
{
  "id": "ev_example_railway_opening_1830",
  "label": "Liverpool and Manchester Railway opens",
  "time": {
    "year_start": 1830,
    "start": "1830-09-15",
    "end": "1830-09-15",
    "precision": "day",
    "certainty": "exact",
    "calendar": "gregorian"
  },
  "question_types": ["timeline_before_after", "timeline_latest_of_3"],
  "relations": [
    {
      "type": "contributes_to",
      "target_id": "ev_example_railway_expansion_1840s",
      "confidence": "medium",
      "evidence_source_ids": ["src_wikipedia_lmr"],
      "note": "The opening demonstrated viability and encouraged further railway investment."
    }
  ],
  "sources": [
    { "id": "src_wikipedia_lmr", "title": "Liverpool and Manchester Railway", "url": "https://en.wikipedia.org/wiki/Liverpool_and_Manchester_Railway" }
  ],
  "status": "draft",
  "content_origin": "ai_assisted_self_reviewed"
}
```

### Example 2: Unit with editorial settings (optional fields)

```json
{
  "id": "unit_industrial_revolution",
  "title": "Industrial Revolution",
  "event_ids": ["ev_...", "ev_..."],
  "preferred_time_precision": "year",
  "default_time_window_policy": {
    "era_windows": [
      { "range": "up_to_1499", "window_years": 50 },
      { "range": "1500_1799", "window_years": 25 },
      { "range": "1800_1899", "window_years": 10 },
      { "range": "1900_plus", "window_years": 5 }
    ]
  },
  "parallel_tracks": { "places": ["place_britain", "place_france"] }
}
```

## Future placeholders

Place/work/concept entities are intentionally out of scope for this iteration and can be added in future revisions without changing the canonical/derived split.
